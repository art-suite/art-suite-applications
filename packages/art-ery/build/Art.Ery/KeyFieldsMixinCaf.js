"use strict"
let Caf = require('caffeine-script-runtime');
Caf.defMod(module, () => {return Caf.importInvoke(["isString", "isPlainArray", "Error", "formattedInspect", "present", "isPlainObject", "log", "Validator"], [global, require('./StandardImport')], (isString, isPlainArray, Error, formattedInspect, present, isPlainObject, log, Validator) => {return function(superClass) {let KeyFieldsMixinCaf; return KeyFieldsMixinCaf = Caf.defClass(class KeyFieldsMixinCaf extends superClass {}, function(KeyFieldsMixinCaf, classSuper, instanceSuper) {let keyFields, defaultKeyFieldsString; this.getKeyFields = function() {return this._keyFields;}; this.getKeyFieldsString = function() {return this._keyFieldsString;}; this.primaryKey = keyFields = function(a) {return isString(a) ? this._keyFields = (this._keyFieldsString = a).split("/") : isPlainArray(a) ? this._keyFieldsString = (this._keyFields = a).join("/") : (() => {throw new Error(`invalid value: ${Caf.toString(formattedInspect(a))}`);})();}; this.keyFields = keyFields; this.getter({keyFieldsString: function() {let temp; return ((temp = this._keyFieldsString) != null ? temp : this._keyFieldsString = this.class._keyFieldsString);}, keyFields: function() {let temp; return ((temp = this._keyFields) != null ? temp : this._keyFields = this.class._keyFields);}, keyValidator: function() {let temp; return ((temp = this._keyValidator) != null ? temp : this._keyValidator = this.class._keyValidator);}}); this.prototype.allKeyFieldsPresent = function(data) {return !Caf.find(this.keyFields, null, (keyField) => !present(data[keyField]));}; this.prototype.isRecord = function(data) {return isPlainObject(data) && this.allKeyFieldsPresent(data);}; this.prototype.dataToKeyString = function(a) {this.validateKey(a); return Caf.array(this.keyFields, (field) => a[field]).join("/");}; this.prototype.createPropsToKeyFunction = function(keyField = "id") {let recordType, matches, propsIdField, propsField; return (keyField === "id") ? (recordType = this.pipelineName, (props, stateField) => {let temp, base; propsField = stateField != null ? stateField : recordType; return ((temp = Caf.exists(base = props[propsField]) && base.id) != null ? temp : props[propsField + "Id"]);}) : (matches = keyField.match(/^(.+)Id$/)) ? (([propsIdField, propsField] = matches), (props) => {let temp, base; return ((temp = Caf.exists(base = props[propsField]) && base.id) != null ? temp : props[propsIdField]);}) : (props) => props[keyField];}; this.getter({propsToKey: function() {let temp; return ((temp = this._propsToKey) != null ? temp : this._propsToKey = (() => {let fMap; return (this.keyFields.length === 1) ? this.createPropsToKeyFunction(this.keyFields[0]) : (fMap = Caf.object(this.keyFields, (v) => this.createPropsToKeyFunction(v), null, null, (v) => v), (props) => Caf.object(fMap, (f) => f(props)));})());}}); this.prototype.toKeyObject = function(a) {let keyValidator, keyObject, splitInput; ({keyValidator, keyFields} = this); keyObject = this.validateKey(isPlainObject(a) ? Caf.object(this.keyFields, (v) => a[v]) : isString(a) ? (keyFields.length > 1) ? (splitInput = a.split("/"), keyObject = Caf.object(keyFields, (v, i) => splitInput[i]), (splitInput.length !== keyFields.length) ? log.warn({KeyFieldsMixin_toKeyObject: {message: "wrong number of /-delimited fields in key-string", pipelineName: this.pipelineName, input: a, splitInput, keyFields, usingKeyObject: keyObject}}) : undefined, keyObject) : {[`${Caf.toString(keyFields[0])}`]: a} : {}); if (keyValidator) {keyObject = keyValidator.preprocess(keyObject);}; return keyObject;}; this.prototype.dataWithoutKeyFields = function(data) {return data && Caf.object(data, null, (v, k) => {return {when: !(Caf.in(k, this.keyFields))};});}; this.prototype.validateKey = function(key) {Caf.each2(this.keyFields, (field) => (() => {throw new Error(`${Caf.toString(this.class.getName())} missing key field(s): ${Caf.toString(formattedInspect({missing: [field, this.keyFields, key]}))}`);})(), (field) => !present(key[field])); return key;}; this._keyFieldsString = defaultKeyFieldsString = "id"; this._keyFields = [defaultKeyFieldsString]; this._initFields = function() {let fields; classSuper._initFields.apply(this, arguments); fields = this.getFields(); return this._keyValidator = new Validator(Caf.object(this.getKeyFields(), (field) => fields[field], (field) => fields[field]));};});};});});
//# sourceMappingURL=KeyFieldsMixinCaf.js.map
