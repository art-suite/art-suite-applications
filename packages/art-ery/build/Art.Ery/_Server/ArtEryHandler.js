"use strict"
let Caf = require('caffeine-script-runtime');
Caf.defMod(module, () => {return Caf.importInvoke(["pipelines", "verifySession", "Promise", "Request", "log", "config", "prepareSignedSessionForResponse"], [global, require('./StandardImport'), require('./ArtErySessionManager')], (pipelines, verifySession, Promise, Request, log, config, prepareSignedSessionForResponse) => {let ArtEryHandler; return ArtEryHandler = Caf.defClass(class ArtEryHandler extends require('art-express-server').PromiseHandler {}, function(ArtEryHandler, classSuper, instanceSuper) {let httpMethodsToArtEryRequestTypes; this.prototype.canHandleRequest = function(request) {let url; ({url} = request); return Caf.find(pipelines, null, (pipeline, pipelineName) => pipeline.restPathRegex.test(url));}; this.prototype.handleApiRequest = function(request, requestData) {let found, pipeline, type, key; return (found = this._findPipelineForRequest(request)) ? (({pipeline, type, key} = found), verifySession(requestData.session).catch(() => null).then((session) => pipeline._processRequest(Request.createFromRemoteRequestProps({pipeline, type, key, requestData, session: session || {}, remoteRequest: request})).then((response) => {let temp; if (response.failed) {log.error(response);} else {if (config.verbose) {log(`${Caf.toString(response.requestString)}: subrequestCount: ${Caf.toString(response.subrequestCount)}, recordsReturned: ${Caf.toString(response.data ? ((temp = response.data.length) != null ? temp : 1) : 0)}`);};}; return prepareSignedSessionForResponse(session, response.responseForRemoteRequest);}))) : Promise.resolve(null);}; httpMethodsToArtEryRequestTypes = {get: "get", post: "create", put: "update", delete: "delete"}; this.prototype._findPipelineForRequest = function(request) {let url, method, found, match, pipeline, __, type, key; ({url, method} = request); return (found = Caf.find(pipelines, (pipeline, pipelineName) => (match = url.match(pipeline.restPathRegex)) ? {match, pipeline} : undefined)) ? (({match, pipeline} = found), ([__, type, key] = match), type || (type = httpMethodsToArtEryRequestTypes[method.toLocaleLowerCase()]), (config.verbose && type && !pipeline.publicRequestTypes[type]) ? log.warn(`ArtEryHandler blocked request: '${Caf.toString(pipeline.name)}.${Caf.toString(type)}': ${Caf.toString((Caf.in(type, pipeline.requestTypes)) ? "not in publicRequestTypes" : "not a valid request-type")}`) : undefined, pipeline.publicRequestTypes[type] && {pipeline, type, key}) : undefined;};});});});
//# sourceMappingURL=ArtEryHandler.js.map
