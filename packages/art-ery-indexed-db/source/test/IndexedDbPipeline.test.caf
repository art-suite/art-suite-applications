import &StandardImport
&ArtConfig.configure()

require "fake-indexeddb/auto"
global.window = global

class Food extends IndexedDbPipeline
  @indexes
    foodByType: :type/createdAt

  @publicRequestTypes :get :create :update :delete

  dbVersion: 2
  dbName: :FoodNetwork
  @addDatabaseFilters fields:
    name: "required trimmedString"
    type: :trimmedString

chainedTest 'init' -> pipelines.food.create data: name: :Throwaway

.thenTest 'create' ->
  pipelines.food.create data: name: :Shane
  .tap (out) ->
    assert.eq out.name, :Shane
    assert.isNumber out.createdAt
    assert.isNumber out.updatedAt
    assert.present out.id

.tapTest
  :get ({id}) ->
    pipelines.food.get key: id
    .tap (out) ->
      assert.eq out.name, :Shane
      assert.isNumber out.createdAt
      assert.eq out.createdAt, out.updatedAt
      assert.present out.id

  :update ({id, name}) ->
    pipelines.food.update key: id, data: name: "" #{name} Delamore
    .then (out) ->
      assert.eq out.name, "" Shane Delamore
      pipelines.food.get key: id
    .then (out) ->
      assert.eq out.name, "" Shane Delamore

  :delete ({id}) ->
    pipelines.food.delete key: id
    .then (deleted) ->
      assert.eq id, deleted.id
      assert.rejects pipelines.food.get key: id
