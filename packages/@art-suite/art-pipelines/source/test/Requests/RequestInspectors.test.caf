import &StandardImport

&ArtConfig.configure()
describe
  filterLogging: ->

    {user} = class User extends Pipeline
      @filter
        name: :myServerFilter
        before: get: (request) -> if request.data?.fail == "beforeServerFilter" then throw new Error else request
        after: get: (response) -> if response.request.data?.fail == "afterServerFilter" then throw new Error else response

      @filter
        name: :myClientFilter
        location: :client
        before: get: (request) -> if request.data?.fail == "beforeClientFilter" then throw new Error else request
        after: get: (response) -> if response.request.data?.fail == "afterClientFilter" then throw new Error else response

      @publicHandler get: -> :hi

    test "server-only filterLog" ->
      user.get returnResponse: true location: :server session: {}
      .then (response) ->
        assert.eq
          simplifyFilterLog response.beforeFilterLog
          beforeFilterLog = []
            :server-pending-created
            :server-pending-myServerFilter-before
            :server-success-user-handler

        assert.eq
          simplifyFilterLog response.afterFilterLog
          afterFilterLog = []
            :server-success-myServerFilter-after
            :server-success-completed

        assert.eq
          simplifyFilterLog response.filterLog
          compactFlattenAll beforeFilterLog, afterFilterLog

    test "client-server filterLog" ->
      user.get returnResponse: true location: :client session: {}
      .then (response) ->
        assert.eq
          simplifyFilterLog response.beforeFilterLog
          beforeFilterLog =
            :client-pending-created
            :client-pending-myClientFilter-before
            :client-pending-continueAtServerLocation
            :server-pending-created
            :server-pending-myServerFilter-before
            :server-success-user-handler

        assert.eq
          simplifyFilterLog response.afterFilterLog
          afterFilterLog = []
            :server-success-myServerFilter-after
            :server-success-completed
            :client-success-resumedAtClientLocation
            :client-success-myClientFilter-after
            :client-success-completed

        assert.eq
          simplifyFilterLog response.filterLog
          compactFlattenAll beforeFilterLog, afterFilterLog

    test "fail in client-before" ->
      assert.rejects user.get returnResponse: true location: :client session: {}, data: fail: :beforeClientFilter
      .then ({props:{response}}) ->
        assert.eq
          simplifyFilterLog response.beforeFilterLog
          []
            :client-pending-created
            :client-clientFailure-myClientFilter-before

    test "fail in server-before" ->
      assert.rejects user.get returnResponse: true location: :client session: {}, data: fail: :beforeServerFilter
      .then ({props:{response}}) ->
        assert.eq
          simplifyFilterLog response.beforeFilterLog
          []
            :server-pending-created
            :server-serverFailure-myServerFilter-before

    test "fail in server-after" ->
      assert.rejects user.get returnResponse: true location: :server session: {}, data: fail: :afterServerFilter
      .then ({props:{response}}) ->
        assert.eq
          simplifyFilterLog response.filterLog
          []
            :server-pending-created
            :server-pending-myServerFilter-before
            :server-success-user-handler
            :server-serverFailure-myServerFilter-after
            :server-serverFailure-completed

    test "fail in client-after" ->
      assert.rejects user.get returnResponse: true location: :client session: {}, data: fail: :afterClientFilter
      .then ({props:{response}}) ->
        assert.eq
          simplifyFilterLog response.filterLog
          []
            :client-pending-created
            :client-pending-myClientFilter-before
            :client-pending-continueAtServerLocation
            :server-pending-created
            :server-pending-myServerFilter-before
            :server-success-user-handler
            :server-success-myServerFilter-after
            :server-success-completed
            :client-success-resumedAtClientLocation
            :client-clientFailure-myClientFilter-after
            :client-clientFailure-completed