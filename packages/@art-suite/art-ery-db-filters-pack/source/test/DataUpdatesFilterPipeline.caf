import &StandardImport

-> class DataUpdatesFilterPipeline extends &SimpleStore
  @registry new PipelineRegistry location: :client

  @publicRequestTypes :subrequestTest :update :delete :usersByEmail

  @filter DataUpdatesFilter

  @filter
    before:
      create: (request) -> request.withMergedData createdAt: 123, updatedAt: 123
      update: (request) -> request.withMergedData updatedAt: 321

  @query
    usersByEmail:
      query:            ({key}) -> array v, k from @db when v.email == key
      dataToKeyString:  ({email}) -> email

  @handlers
    subrequestTest: (request) ->
      {key, data, type} = request.data
      request.require isString(type), "subrequestTest needs a request-type"
      .then -> request.subrequest request.pipelineName, type, {} key, data
