import &StandardImport

class SimplePipeline extends Pipeline
  @abstractClass()

  constructor: ->
    @_store = {}
    @_nextUniqueKey = 0

  @getter
    :store
    nextUniqueKey: ->
      @_nextUniqueKey++ while @_store[@_nextUniqueKey]
      (@_nextUniqueKey++).toString()

  @publicHandlers
    reset: ({data}) ->
      @_store = data || {}
      {}

    get:    ({key}) -> @_store[key]
    getAll: -> array k in (Object.keys(@_store).sort()) with @store[k]

    create: (request) ->
      {data} = request
      data = if data.id
        data
      else
        merge data, id: @nextUniqueKey

      if @_store[data.id]
            request.clientFailure "" Record already exists with id: #{data.id}
      else  @_store[data.id] = data

    update: ({key, data}) -> @_store[key] = merge previousData, data if previousData = @_store[key]
    delete: ({key}) ->
      if previousData = @_store[key]
        @_store[key] = null
        previousData
