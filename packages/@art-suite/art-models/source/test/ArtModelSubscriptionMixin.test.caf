import &StandardImport, {} &ApplicationState


newRegistry = ->
  registry = new ArtModelRegistry
  class MyModel extends ApplicationState
    @registry registry
  registry

describe
  subscribeOnModelRegistered: ->

    test "subscribeOnModelRegistered" ->
      new Promise (resolve, reject) ->
        {models} = registry = newRegistry()
        class MyModelB extends ArtModel
          @registry registry

        class MyModelA extends ArtModelSubscriptionsMixin ArtModel
          @modelRegistry registry

          constructor: ->
            @subscribeOnModelRegistered :mySubscriptionKey :myModelB :myModelKey updatesCallback: ->
            .then resolve, reject

  "subscribe and initialModelRecord": ->

    test "with stateField and initialModelRecord" ->
      {models, modelStore} = registry = newRegistry()

      new class MyObject extends ArtModelSubscriptionsMixin BaseObject
        @modelRegistry registry

        constructor: ->
          @subscribe :mySubscriptionKey :myModel :myModelKey,
            initialModelRecord: data: :myInitialData
            stateField: :myStateField

      assert.selectedEq
        status:         pending
        data:           :myInitialData
        key:            :myModelKey
        modelName:      :myModel
        modelStore.get  :myModel :myModelKey

      modelStore.onNextReady()

    test "with stateField and no initialModelRecord" ->
      {models, modelStore} = registry = newRegistry()

      new class MyObject extends ArtModelSubscriptionsMixin BaseObject
        @modelRegistry registry

        constructor: -> @subscribe :mySubscriptionKey :myModel :myModelKey, stateField: :myStateField

      assert.selectedEq
        status:     missing
        key:        "myModelKey"
        modelName:  "myModel"
        modelStore.get "myModel", "myModelKey"
