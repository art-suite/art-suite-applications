import &StandardImport

class MockPusherService extends BaseObject
  @singletonClass()
  constructor: ->
    @_subscriptionsByChannel = {}

  @getter
    eventHandlerCount: ->
      count = 0
      each {eventHandlers}, channel in @_subscriptionsByChannel
        each handlers in eventHandlers
          count += handlers.length
      count

  subscribe: (channel) ->
    @_subscriptionsByChannel[channel] ?=
      eventHandlers: {}
      bind: (event, handler) ->
        @_subscriptionsByChannel[channel].eventHandlers[event] ?= []
        .push handler

      unbind: (event, handler) ->
        @_subscriptionsByChannel[channel].eventHandlers[event] = arrayWithoutValue
          @_subscriptionsByChannel[channel].eventHandlers[event]
          handler

  unsubscribe: (channel) ->
    if find eventHandlerForRequestType in @_subscriptionsByChannel[channel].eventHandlers when eventHandlerForRequestType.length > 0
      throw new Error "" Existing subscription has >0 eventHandlers. Should call `unbind` first.\n#{} formattedInspect {} channel, @_subscriptionsByChannel[channel].eventHandlers

    delete @_subscriptionsByChannel[channel]

  trigger: (channel, event, payload) ->
    timeout 10 ->
      each handler in @_subscriptionsByChannel[channel]?.eventHandlers?[event]
        handler payload
    .then -> status: 200

.singleton
