"use strict"
let Caf = require('caffeine-script-runtime');
Caf.defMod(module, () => {return Caf.importInvoke(["Config", "compact", "isBrowser", "log"], [global, require('./StandardImport'), {Config: require('./Config'), ArtEry: require('art-ery')}], (Config, compact, isBrowser, log) => {let config, verboseLog, encodePusherChannelName, getPusherChannel; config = Config.config; verboseLog = Config.verboseLog; encodePusherChannelName = function(key) {return Caf.exists(key) && key.replace(/[^-a-zA-Z0-9_=@,;]/g, ";");}; return {verboseLog, getPusherChannel: getPusherChannel = function(pipelineName, queryName, key) {return encodePusherChannelName(compact([encodePusherChannelName(pipelineName), encodePusherChannelName(queryName), encodePusherChannelName(key)]).join("."));}, subscribeToPusherChangeEvents: function(pipelineName, queryName, key, handler) {let pusherClient, channelName, eventName, channel; return (pusherClient = Config.pusherClient) ? (channelName = getPusherChannel(pipelineName, queryName, key), eventName = config.pusherEventName, verboseLog({subscribe: {channelName}}), channel = pusherClient.subscribe(channelName), channel.bind(eventName, handler), {unsubscribe: () => {verboseLog({unsubscribe: {channelName}}); channel.unbind(eventName, handler); return pusherClient.unsubscribe(channelName);}}) : undefined;}, sendPusherChangedEvent: function(pipelineName, queryName, key, payload) {let pusherEventName, channel, request; pusherEventName = config.pusherEventName; channel = getPusherChannel(pipelineName, queryName, key); return (Config.pusherServer != null) ? (verboseLog({"sendPusherChangedEvent-sending": {request: request = {channel, pusherEventName, pipelineName, key, payload}}}), Config.pusherServer.trigger(channel, pusherEventName, payload || {}).then((response) => (response.status !== 200) ? verboseLog({"sendPusherChangedEvent-unspectedResponse": {request, response}}) : undefined).catch((error) => log.error({"art-ery-pusher-sendPusherChangedEvent-error": {request, error}})), true) : (verboseLog({"sendPusherChangedEvent-pretend-sending": {info: `PusherServer not set. ${Caf.toString(isBrowser ? "Cannot send events FROM the browser. ArtEryServer required." : "Cannot send event.")}`, channel, pusherEventName, pipelineName, key, payload}}), false);}};});});
//# sourceMappingURL=Lib.js.map
